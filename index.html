<html><head><base href="." />
<title>Xtreme Adventure - Sistema de Ventas</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 20px;
    background-color: #f8f9fa;
  }

  .header {
    background: linear-gradient(135deg, #1e4d92, #2c73d2);
    color: white;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 30px;
  }

  .form-container {
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0,0,0,0.1);
  }

  .table tbody tr:hover {
    background-color: #f5f5f5;
    cursor: pointer;
  }

  .resource-unavailable {
    color: #dc3545;
    background-color: #ffe6e6;
  }

  .resource-available {
    color: #198754;
  }

  .resource-disabled {
    opacity: 0.5;
    pointer-events: none;
    background-color: #f0f0f0;
  }

  .availability-info {
    font-size: 0.9em;
    margin-top: 5px;
    color: #666;
  }

  .unavailable {
    background-color: #ffe6e6;
  }
</style>
</head>
<body>

<div class="container">
  <div class="header text-center">
    <h1>Xtreme Adventure</h1>
    <h4>Sistema de Registro de Ventas</h4>
  </div>

  <div class="form-container">
    <form id="ventasForm">
      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">Nombre del Cliente</label>
          <input type="text" class="form-control" id="nombreCliente" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Teléfono del Cliente</label>
          <input type="tel" class="form-control" id="telefonoCliente" pattern="[0-9]*" onkeypress="return /[0-9]/i.test(event.key)" required>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-4">
          <label class="form-label">Tour</label>
          <select class="form-select" id="tour" required>
            <option value="">Seleccione un tour</option>
            <option value="Cabalgata">Cabalgata (1.5 hrs)</option>
            <option value="Cuatrimotos">Cuatrimotos (1.5 hrs)</option>
            <option value="ReservaVenados">Reserva de Venados (1.5 hrs)</option>
            <option value="TunelesVolcanicos">Túneles Volcánicos (2 hrs)</option>
            <option value="MixtoVenados">Mixto a Venados (1:40 hrs)</option>
            <option value="RutasLargas">Rutas Largas (3 hrs)</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Número de Personas</label>
          <input type="number" class="form-control" id="numPersonas" min="1" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">Fecha y Hora del Tour</label>
          <input type="datetime-local" class="form-control" id="fechaHora" required>
        </div>
      </div>

      <div id="cuatrimotosSection" style="display:none;">
        <div class="row mb-3">
          <div class="col-12">
            <label class="form-label">Cuatrimotos Disponibles</label>
            <div class="form-check">
              <div id="cuatrimotosDisponibles">
                <!-- Se llenará dinámicamente -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="vehiculoSection" style="display:none;">
        <div class="row mb-3">
          <div class="col-12">
            <label class="form-label">Vehículos Disponibles</label>
            <div id="vehiculosDisponibles">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="Aveo" id="vehiculo-aveo">
                <label class="form-check-label" for="vehiculo-aveo">Aveo</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="Pointer" id="vehiculo-pointer">
                <label class="form-check-label" for="vehiculo-pointer">Pointer</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="Sentra" id="vehiculo-sentra">
                <label class="form-check-label" for="vehiculo-sentra">Sentra</label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-3">
          <label class="form-label">Costo del Tour</label>
          <input type="number" class="form-control" id="costoTour" required>
        </div>
        <div class="col-md-3" id="costoTotalContainer" style="display:none;">
          <label class="form-label">Costo Total a pagar</label>
          <input type="number" class="form-control" id="costoTotalPagar" readonly>
        </div>
        <div class="col-md-3">
          <label class="form-label">Anticipo</label>
          <input type="number" class="form-control" id="anticipo" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">Pago Restante</label>
          <input type="number" class="form-control" id="pagoRestante" readonly>
        </div>
        <div class="col-md-3">
          <label class="form-label">Método de Pago</label>
          <select class="form-select" id="metodoPago" required>
            <option value="">Selecione método</option>
            <option value="Efectivo">Efectivo</option>
            <option value="Terminal">Terminal</option>
            <option value="Transferencia">Transferencia</option>
          </select>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-4">
          <label class="form-label">Vendedor</label>
          <select class="form-select" id="vendedor" required>
            <option value="">Seleccione vendedor</option>
            <!-- Lista de vendedores -->
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Persona que recibió el pago</label>
          <select class="form-select" id="receptorPago" required>
            <option value="">Seleccione receptor</option>
            <!-- Lista de receptores -->
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Guía para el tour</label>
          <div id="guiasDisponibles">
            <!-- Will be populated dynamically -->
          </div>
          <div id="guiaAvailability" class="availability-info"></div>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-12">
          <label class="form-label">Observaciones</label>
          <textarea class="form-control" id="observaciones" rows="3"></textarea>
        </div>
      </div>

      <div class="text-center">
        <button type="submit" class="btn btn-primary me-2">Registrar Venta</button>
        <button type="button" class="btn btn-secondary" id="limpiarFormulario">Limpiar Formulario</button>
      </div>
    </form>
  </div>

  <div class="mt-4">
    <button id="exportarExcel" class="btn btn-success mb-3">
      Exportar a Excel
    </button>
    <button id="eliminarVentas" class="btn btn-danger mb-3 ms-2" style="display:none;">
      Eliminar Seleccionados
    </button>
    <button id="toggleEliminar" class="btn btn-warning mb-3 ms-2">
      Eliminar registros
    </button>

    <h3>Registro de Ventas</h3>
    <div class="table-responsive">
      <table class="table table-striped" id="ventasTable">
        <thead>
          <tr>
            <th style="display:none"><input type="checkbox" id="selectAllVentas"> Seleccionar</th>
            <th>Fecha/Hora</th>
            <th>Cliente</th>
            <th>Tour</th>
            <th>Guía(s)</th>
            <th>Vehículo/Cuatrimoto</th>
            <th>Total</th>
            <th>Estado</th>
            <th>Vendedor</th>
            <th>Próxima Disponibilidad</th>
            <th>Observaciones</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal fade" id="cancelacionModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cancelar Tour</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="cancelacionForm">
          <div class="mb-3">
            <label class="form-label">Motivo de Cancelación</label>
            <textarea class="form-control" id="motivoCancelacion" required></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-danger" id="confirmarCancelacion">Confirmar Cancelación</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const DURACIONES = {
  'Cabalgata': 90,
  'Cuatrimotos': 90,
  'ReservaVenados': 90,
  'TunelesVolcanicos': 120,
  'MixtoVenados': 100,
  'RutasLargas': 180
};

let deleteMode = false;

class Reserva {
  constructor(nombreCliente, telefonoCliente, fechaHora, duracion, recursos, observaciones, isCanceled = false) {
    this.nombreCliente = nombreCliente;
    this.telefonoCliente = telefonoCliente;
    this.fechaHora = new Date(fechaHora);
    this.duracion = duracion;
    this.recursos = recursos;
    this.observaciones = observaciones;
    this.isCanceled = isCanceled;
    this.fechaFin = new Date(this.fechaHora.getTime() + duracion * 60000);
  }
}

class SistemaReservas {
  constructor() {
    this.reservas = this.cargarReservas();
  }

  cargarReservas() {
    const reservasGuardadas = localStorage.getItem('reservas');
    if (!reservasGuardadas) return [];

    return JSON.parse(reservasGuardadas).map(r => {
      return new Reserva(
        r.nombreCliente,
        r.telefonoCliente,
        r.fechaHora,
        r.duracion,
        r.recursos,
        r.observaciones,
        r.isCanceled
      );
    });
  }

  guardarReservas() {
    localStorage.setItem('reservas', JSON.stringify(this.reservas));
  }

  agregarReserva(reserva) {
    this.reservas.push(reserva);
    this.guardarReservas();
  }

  cancelarReserva(index) {
    if (this.reservas[index]) {
      this.reservas[index].isCanceled = true;
      this.guardarReservas();
    }
  }

  estaDisponible(recurso, fechaHora, duracion) {
    const inicio = new Date(fechaHora);
    const fin = new Date(inicio.getTime() + duracion * 60000);

    return !this.reservas.some(reserva => {
      if (reserva.isCanceled) return false;

      const reservaInicio = new Date(reserva.fechaHora);
      const reservaFin = new Date(reservaInicio.getTime() + reserva.duracion * 60000);

      const hayConflicto = (inicio < reservaFin && fin > reservaInicio);
      return hayConflicto && reserva.recursos.includes(recurso);
    });
  }
}

const sistemaReservas = new SistemaReservas();

function formatearFecha(fecha) {
  return new Date(fecha).toLocaleString();
}

document.getElementById('fechaHora').addEventListener('change', function() {
  actualizarDisponibilidad();
});

function actualizarDisponibilidad() {
  const fechaHora = document.getElementById('fechaHora').value;
  const tour = document.getElementById('tour').value;
  if (!fechaHora || !tour) return;

  const duracion = DURACIONES[tour];

  document.querySelectorAll('#vehiculosDisponibles input[type="checkbox"]').forEach(checkbox => {
    const disponible = sistemaReservas.estaDisponible(checkbox.value, fechaHora, duracion);
    checkbox.disabled = !disponible;
    checkbox.parentElement.classList.toggle('resource-disabled', !disponible);
  });

  document.querySelectorAll('#cuatrimotosDisponibles input[type="checkbox"]').forEach(checkbox => {
    const disponible = sistemaReservas.estaDisponible(checkbox.value, fechaHora, duracion);
    checkbox.disabled = !disponible;
    checkbox.parentElement.classList.toggle('resource-disabled', !disponible);
  });

  document.querySelectorAll('#guiasDisponibles input[type="checkbox"]').forEach(checkbox => {
    const disponible = sistemaReservas.estaDisponible(checkbox.value, fechaHora, duracion);
    checkbox.disabled = !disponible;
    checkbox.parentElement.classList.toggle('resource-disabled', !disponible);
  });
}

document.getElementById('tour').addEventListener('change', function() {
  const tour = this.value;
  const vehiculoSection = document.getElementById('vehiculoSection');
  const cuatrimotosSection = document.getElementById('cuatrimotosSection');
  
  vehiculoSection.style.display = 'none';
  cuatrimotosSection.style.display = 'none';
  
  if (['ReservaVenados', 'MixtoVenados', 'TunelesVolcanicos'].includes(tour)) {
    vehiculoSection.style.display = 'block';
  }
  
  if (['Cuatrimotos', 'MixtoVenados', 'RutasLargas'].includes(tour)) {
    cuatrimotosSection.style.display = 'block';
  }
  
  actualizarDisponibilidad();
});

document.getElementById('ventasForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  // Collect all form data
  const nombreCliente = document.getElementById('nombreCliente').value;
  const telefonoCliente = document.getElementById('telefonoCliente').value;
  const fechaHora = document.getElementById('fechaHora').value;
  const tour = document.getElementById('tour').value;
  const numPersonas = document.getElementById('numPersonas').value;
  const duracion = DURACIONES[tour];
  const costoTour = parseFloat(document.getElementById('costoTour').value);
  const anticipo = parseFloat(document.getElementById('anticipo').value);
  const metodoPago = document.getElementById('metodoPago').value;
  const vendedor = document.getElementById('vendedor').value;
  const receptorPago = document.getElementById('receptorPago').value;
  const observaciones = document.getElementById('observaciones').value;
  
  // Collect selected guides
  const guias = Array.from(document.querySelectorAll('#guiasDisponibles input:checked'))
    .map(input => input.value);
  
  // Collect selected vehicles
  const vehiculos = Array.from(document.querySelectorAll('#vehiculosDisponibles input:checked'))
    .map(input => input.value);
    
  // Collect selected ATVs (cuatrimotos)
  const cuatrimotos = Array.from(document.querySelectorAll('#cuatrimotosDisponibles input:checked'))
    .map(input => input.value);
  
  // Combine all resources
  const recursos = [...guias, ...vehiculos, ...cuatrimotos];
  
  // Calculate total cost
  let costoTotal = costoTour;
  if (metodoPago === 'Terminal') {
    costoTotal = costoTour * 1.04;
  }
  
  // Create new reservation
  const nuevaReserva = new Reserva(
    nombreCliente,
    telefonoCliente,
    fechaHora,
    duracion,
    recursos,
    observaciones
  );
  
  // Add additional properties
  nuevaReserva.tour = tour;
  nuevaReserva.numPersonas = numPersonas;
  nuevaReserva.costoTotal = costoTotal;
  nuevaReserva.anticipo = anticipo;
  nuevaReserva.metodoPago = metodoPago;
  nuevaReserva.vendedor = vendedor;
  nuevaReserva.receptorPago = receptorPago;
  
  // Check if we're editing an existing entry
  const submitBtn = document.querySelector('button[type="submit"]');
  if (submitBtn.dataset.editIndex) {
    // Update existing reservation
    const index = parseInt(submitBtn.dataset.editIndex);
    sistemaReservas.reservas[index] = nuevaReserva;
    delete submitBtn.dataset.editIndex;
    submitBtn.textContent = 'Registrar Venta';
  } else {
    // Add new reservation
    sistemaReservas.agregarReserva(nuevaReserva);
  }
  
  // Save and refresh display
  sistemaReservas.guardarReservas();
  renderizarReservasGuardadas();
  
  // Clear form
  document.getElementById('limpiarFormulario').click();
  
  alert('Venta registrada exitosamente');
});

document.getElementById('limpiarFormulario').addEventListener('click', function() {
  document.getElementById('ventasForm').reset();
  
  document.getElementById('cuatrimotosSection').style.display = 'none';
  document.getElementById('vehiculoSection').style.display = 'none';
  document.getElementById('costoTotalContainer').style.display = 'none';
  
  document.querySelectorAll('#cuatrimotosDisponibles input[type="checkbox"]').forEach(checkbox => {
    checkbox.checked = false;
  });
  
  document.querySelectorAll('#vehiculosDisponibles input[type="checkbox"]').forEach(checkbox => {
    checkbox.checked = false;
  });
  
  document.getElementById('guia').selectedIndex = -1;
  
  document.getElementById('costoTotalPagar').value = '';
  document.getElementById('anticipo').value = '';

  const submitBtn = document.querySelector('button[type="submit"]');
  submitBtn.textContent = 'Registrar Venta';
  delete submitBtn.dataset.editIndex;
  
  document.getElementById('guiaAvailability').textContent = '';
});

function getTourStatus(fechaHora, duracion, isCanceled = false) {
  if (isCanceled) return 'Cancelado';
  
  const ahora = new Date();
  const inicio = new Date(fechaHora);
  const fin = new Date(inicio.getTime() + duracion * 60000);
  
  if (ahora < inicio) return 'Pendiente';
  if (ahora > fin) return 'Finalizado';
  return 'En Curso';
}

function editVenta(rowIndex) {
  const row = document.querySelector(`#ventasTable tbody tr:nth-child(${rowIndex + 1})`);
  if (!row) return;

  const cells = row.cells;
  
  const fechaHoraText = cells[1].textContent;
  const nombreCliente = cells[2].textContent;
  const tourText = cells[3].textContent;
  const guiasText = cells[4].textContent;
  const vehiculosText = cells[5].textContent;
  const costoText = cells[6].textContent.replace('$', '');
  const observaciones = cells[9].textContent;
  
  try {
    const [datePart, timePart] = fechaHoraText.split(', ');
    const [day, month, year] = datePart.split('/');
    const [hours, minutes] = timePart.split(':');
    
    const fechaHora = new Date(year, month - 1, day, hours, minutes);
    
    const pad = num => num.toString().padStart(2, '0');
    const fechaHoraISO = `${year}-${pad(month)}-${pad(day)}T${pad(hours)}:${pad(minutes)}`;
    
    document.getElementById('fechaHora').value = fechaHoraISO;
  } catch (e) {
    console.error('Error parsing date:', e);
    const now = new Date();
    document.getElementById('fechaHora').value = now.toISOString().slice(0, 16);
  }

  document.getElementById('nombreCliente').value = nombreCliente;
  
  const tourSelect = document.getElementById('tour');
  Array.from(tourSelect.options).forEach(option => {
    if (option.text.includes(tourText)) {
      tourSelect.value = option.value;
      tourSelect.dispatchEvent(new Event('change'));
    }
  });

  const vehiculosArray = vehiculosText !== 'N/A' ? vehiculosText.split(', ') : [];
  document.querySelectorAll('#vehiculosDisponibles input[type="checkbox"]').forEach(checkbox => {
    checkbox.checked = vehiculosArray.includes(checkbox.value);
  });

  const guiaSelect = document.getElementById('guia');
  const guiasArray = guiasText.split(', ');
  Array.from(guiaSelect.options).forEach(option => {
    option.selected = guiasArray.includes(option.value);
  });

  document.getElementById('costoTour').value = costoText;
  document.getElementById('observaciones').value = observaciones;

  if (tourText.includes('Cuatrimotos')) {
    const cuatrimotosSeleccionadas = vehiculosText.split(', ');
    document.querySelectorAll('#cuatrimotosDisponibles input[type="checkbox"]').forEach(checkbox => {
      checkbox.checked = cuatrimotosSeleccionadas.includes(checkbox.value);
    });
    document.getElementById('cuatrimotosSection').style.display = 'block';
  } else {
    document.querySelectorAll('#cuatrimotosDisponibles input[type="checkbox"]').forEach(checkbox => {
      checkbox.checked = false;
    });
    document.getElementById('cuatrimotosSection').style.display = 'none';
  }

  if (document.getElementById('metodoPago').value === 'Terminal') {
    document.getElementById('costoTotalPagar').value = (parseFloat(costoText) * 1.04).toFixed(2);
    document.getElementById('costoTotalContainer').style.display = 'block';
  }
  
  const submitBtn = document.querySelector('button[type="submit"]');
  submitBtn.textContent = 'Actualizar Venta';
  submitBtn.dataset.editIndex = rowIndex;

  document.getElementById('ventasForm').scrollIntoView({ behavior: 'smooth' });
}

function showCancelacionModal(rowIndex) {
  const modal = new bootstrap.Modal(document.getElementById('cancelacionModal'));
  document.getElementById('confirmarCancelacion').onclick = function() {
    const motivo = document.getElementById('motivoCancelacion').value;
    if (!motivo) return;
    
    sistemaReservas.cancelarReserva(rowIndex);
    
    const row = document.querySelector(`#ventasTable tbody tr:nth-child(${rowIndex + 1})`);
    const statusCell = row.cells[6];
    statusCell.textContent = 'Cancelado';
    statusCell.classList.add('text-danger');
    
    document.getElementById('motivoCancelacion').value = '';
    modal.hide();
  };
  modal.show();
}

function renderizarReservasGuardadas() {
  const tabla = document.getElementById('ventasTable').getElementsByTagName('tbody')[0];
  tabla.innerHTML = '';
  
  sistemaReservas.reservas.forEach((reserva, index) => {
    const row = tabla.insertRow();
    row.innerHTML = `
      <td style="display:none">
        <input type="checkbox" class="venta-checkbox" data-index="${index}">
      </td>
      <td>${formatearFecha(reserva.fechaHora)}</td>
      <td>${reserva.nombreCliente}</td>
      <td>${reserva.tour || ''}</td>
      <td>${reserva.recursos.filter(r => !r.includes('Cuatri')).join(', ')}</td>
      <td>${reserva.recursos.filter(r => r.includes('Cuatri')).join(', ') || 'N/A'}</td>
      <td>$${reserva.costoTotal || ''}</td>
      <td class="${reserva.isCanceled ? 'text-danger' : ''}">${getTourStatus(reserva.fechaHora, reserva.duracion, reserva.isCanceled)}</td>
      <td>${reserva.vendedor || ''}</td>
      <td>${formatearFecha(reserva.fechaFin)}</td>
      <td>${reserva.observaciones || ''}</td>
      <td>
        <button class="btn btn-sm btn-primary" onclick="editVenta(${index})">Editar</button>
        <button class="btn btn-sm btn-danger" onclick="showCancelacionModal(${index})">Cancelar</button>
      </td>
    `;
  });
}

function toggleDeleteMode() {
  deleteMode = !deleteMode;
  const checkboxCells = document.querySelectorAll('#ventasTable td:first-child, #ventasTable th:first-child');
  const deleteBtn = document.getElementById('eliminarVentas');
  const toggleBtn = document.getElementById('toggleEliminar');
  
  if(checkboxCells) {
    checkboxCells.forEach(cell => {
      if(cell) {
        cell.style.display = deleteMode ? '' : 'none';
      }
    });
  }
  
  if(deleteBtn) {
    deleteBtn.style.display = deleteMode ? 'inline' : 'none';
  }
  
  if(toggleBtn) {
    toggleBtn.textContent = deleteMode ? 'Cancelar' : 'Eliminar registros';
    toggleBtn.classList.toggle('btn-danger');
    toggleBtn.classList.toggle('btn-warning');
  }
}

function deleteSelectedVentas() {
  const selectedIndexes = [];
  document.querySelectorAll('.venta-checkbox:checked').forEach(cb => {
    selectedIndexes.push(parseInt(cb.dataset.index));
  });
  
  selectedIndexes.sort((a, b) => b - a);
  
  if (confirm(`¿Está seguro de eliminar ${selectedIndexes.length} registro(s)?`)) {
    selectedIndexes.forEach(index => {
      sistemaReservas.reservas.splice(index, 1);
    });
    sistemaReservas.guardarReservas();
    renderizarReservasGuardadas();
    toggleDeleteMode();
  }
}

// Add event listeners
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('costoTour').addEventListener('input', updateRemainingPayment);
  document.getElementById('anticipo').addEventListener('input', updateRemainingPayment);

  function updateRemainingPayment() {
    const costoTour = parseFloat(document.getElementById('costoTour').value) || 0;
    const anticipo = parseFloat(document.getElementById('anticipo').value) || 0;
    const metodoPago = document.getElementById('metodoPago').value;
    
    let costoTotal = costoTour;
    if (metodoPago === 'Terminal') {
      costoTotal = costoTour * 1.04;
    }
    
    const pagoRestante = costoTotal - anticipo;
    document.getElementById('pagoRestante').value = pagoRestante.toFixed(2);
  }

  // Update metodoPago event listener
  document.getElementById('metodoPago').addEventListener('change', function() {
    const costoTotalContainer = document.getElementById('costoTotalContainer');
    const costoTour = parseFloat(document.getElementById('costoTour').value) || 0;
    
    if (this.value === 'Terminal') {
      document.getElementById('costoTotalPagar').value = (costoTour * 1.04).toFixed(2);
      costoTotalContainer.style.display = 'block';
    } else {
      costoTotalContainer.style.display = 'none';
      document.getElementById('costoTotalPagar').value = '';
    }
    
    updateRemainingPayment();
  });

  document.getElementById('costoTour').addEventListener('input', function() {
    const metodoPago = document.getElementById('metodoPago').value;
    const costoTotalContainer = document.getElementById('costoTotalContainer');
    const costoTour = parseFloat(this.value) || 0;
    
    if (metodoPago === 'Terminal') {
      document.getElementById('costoTotalPagar').value = (costoTour * 1.04).toFixed(2);
      costoTotalContainer.style.display = 'block';
    }
    
    updateRemainingPayment();
  });

  // Initialize delete mode elements
  const deleteBtn = document.getElementById('eliminarVentas');
  const toggleBtn = document.getElementById('toggleEliminar');
  const exportBtn = document.getElementById('exportarExcel');
  
  if(toggleBtn) {
    toggleBtn.addEventListener('click', toggleDeleteMode);
  }
  
  if(deleteBtn) {
    deleteBtn.addEventListener('click', deleteSelectedVentas);
  }
  
  if(exportBtn) {
    exportBtn.addEventListener('click', exportarAExcel);
  }

  // Initialize select all checkbox
  const selectAllCheckbox = document.getElementById('selectAllVentas');
  if(selectAllCheckbox) {
    selectAllCheckbox.addEventListener('change', function() {
      document.querySelectorAll('.venta-checkbox').forEach(cb => {
        cb.checked = this.checked;
      });
    });
  }

  // Initialize the rest of the page
  inicializarSelectores();
  actualizarDisponibilidad();
  renderizarReservasGuardadas();
});

function inicializarSelectores() {
  const vendedores = [
    'Iván J', 'Monse', 'Erick V', 'Alexia', 'Fredy O', 
    'Ana', 'Manuel A', 'Luis A', 'Joaquín'
  ];
  
  const receptores = [
    'Iván J', 'Monse', 'Erick V', 'Alexia', 'Fredy O', 
    'Ana', 'Manuel A', 'Luis A', 'Mayra', 'Joaquín', 
    'Ángel', 'Alberto', 'Ángel', 'Toño'
  ];
  
  const guias = [
    'Alberto C', 'Iván J', 'Ángel', 'Toño', 
    'Luis A', 'Joaquín', 'Luis'
  ];

  const vendedorSelect = document.getElementById('vendedor');
  vendedores.forEach(vendedor => {
    const option = document.createElement('option');
    option.value = vendedor;
    option.textContent = vendedor;
    vendedorSelect.appendChild(option);
  });

  const receptorSelect = document.getElementById('receptorPago');
  receptores.forEach(receptor => {
    const option = document.createElement('option');
    option.value = receptor;
    option.textContent = receptor;
    receptorSelect.appendChild(option);
  });

  const guiasDiv = document.getElementById('guiasDisponibles');
  guiasDiv.innerHTML = '';
  guias.forEach(guia => {
    const div = document.createElement('div');
    div.className = 'form-check';
    div.innerHTML = `
      <input class="form-check-input guia-checkbox" type="checkbox" value="${guia}" id="guia-${guia.replace(/\s+/g, '')}">
      <label class="form-check-label" for="guia-${guia.replace(/\s+/g, '')}">${guia}</label>
    `;
    guiasDiv.appendChild(div);
  });

  const cuatrimotosDiv = document.getElementById('cuatrimotosDisponibles');
  const cuatrimotos = ['Cuatri #1', 'Cuatri #2', 'Cuatri #3', 'Cuatri #4', 'Cuatri #5', 'Cuatri extra #6'];
  cuatrimotosDiv.innerHTML = '';
  cuatrimotos.forEach(cuatri => {
    const div = document.createElement('div');
    div.className = 'form-check';
    div.innerHTML = `
      <input class="form-check-input" type="checkbox" value="${cuatri}" id="${cuatri.replace(/\s+/g, '')}">
      <label class="form-check-label" for="${cuatri.replace(/\s+/g, '')}">${cuatri}</label>
    `;
    cuatrimotosDiv.appendChild(div);
  });
}

// Ensure DOM is loaded before initializing
document.addEventListener('DOMContentLoaded', function() {
  inicializarSelectores();
  actualizarDisponibilidad();
  renderizarReservasGuardadas();
});

function exportarAExcel() {
  const table = document.getElementById('ventasTable');
  
  const rows = Array.from(table.querySelectorAll('tr'));
  
  const headers = Array.from(rows[0].cells)
    .map(cell => cell.textContent)
    .filter(text => text !== 'Seleccionar' && text !== 'Acciones');
  
  const data = rows.slice(1).map(row => {
    return Array.from(row.cells)
      .map(cell => cell.textContent)
      .filter((_, index) => {
        return index !== 0 && index !== row.cells.length - 1;
      });
  });
  
  const csvContent = [
    headers.join(','),
    ...data.map(row => row.join(','))
  ].join('\n');
  
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.setAttribute('href', url);
  link.setAttribute('download', `registro_ventas_${new Date().toISOString().slice(0,10)}.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// Add event listener for export button
document.getElementById('exportarExcel').addEventListener('click', exportarAExcel);
</script>

</body></html>