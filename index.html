<html><head><base href="." />
<title>Xtreme Adventure - Sistema de Ventas</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
<style>
  body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 20px;
    background-color: #f8f9fa;
  }
  
  .header {
    background: linear-gradient(135deg, #1e4d92, #2c73d2);
    color: white;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 30px;
  }

  .form-container {
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0,0,0,0.1);
  }

  .table tbody tr:hover {
    background-color: #f5f5f5;
    cursor: pointer;
  }

  .resource-unavailable {
    color: #dc3545;
    background-color: #ffe6e6;
  }

  .resource-available {
    color: #198754;
  }

  .availability-info {
    font-size: 0.9em;
    margin-top: 5px;
    color: #666;
  }

  .unavailable {
    background-color: #ffe6e6;
  }
</style>
</head>
<body>

<div class="container">
  <div class="header text-center">
    <h1>Xtreme Adventure</h1>
    <h4>Sistema de Registro de Ventas</h4>
  </div>

  <div class="form-container">
    <form id="ventasForm">
      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">Nombre del Cliente</label>
          <input type="text" class="form-control" id="nombreCliente" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Teléfono del Cliente</label>
          <input type="tel" class="form-control" id="telefonoCliente" required>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-4">
          <label class="form-label">Tour</label>
          <select class="form-select" id="tour" required>
            <option value="">Seleccione un tour</option>
            <option value="Cabalgata">Cabalgata (1.5 hrs)</option>
            <option value="Cuatrimotos">Cuatrimotos (1.5 hrs)</option>
            <option value="ReservaVenados">Reserva de Venados (1.5 hrs)</option>
            <option value="TunelesVolcanicos">Túneles Volcánicos (2 hrs)</option>
            <option value="RutasLargas">Rutas Largas (4 hrs)</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Número de Personas</label>
          <input type="number" class="form-control" id="numPersonas" min="1" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">Fecha y Hora del Tour</label>
          <input type="datetime-local" class="form-control" id="fechaHora" required>
        </div>
      </div>

      <div id="cuatrimotosSection" style="display:none;">
        <div class="row mb-3">
          <div class="col-12">
            <label class="form-label">Cuatrimotos Disponibles</label>
            <div class="form-check">
              <div id="cuatrimotosDisponibles">
                <!-- Se llenará dinámicamente -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="vehiculoSection" style="display:none;">
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Vehículo</label>
            <select class="form-select" id="vehiculo">
              <option value="">Seleccione un vehículo</option>
              <option value="Pointer">Pointer</option>
              <option value="Sentra">Sentra</option>
            </select>
          </div>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-3">
          <label class="form-label">Costo del Tour</label>
          <input type="number" class="form-control" id="costoTour" required>
        </div>
        <div class="col-md-3" id="costoTotalContainer" style="display:none;">
          <label class="form-label">Costo Total a pagar</label>
          <input type="number" class="form-control" id="costoTotalPagar" readonly>
        </div>
        <div class="col-md-3">
          <label class="form-label">Anticipo</label>
          <input type="number" class="form-control" id="anticipo" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">Pago Restante</label>
          <input type="number" class="form-control" id="pagoRestante" readonly>
        </div>
        <div class="col-md-3">
          <label class="form-label">Método de Pago</label>
          <select class="form-select" id="metodoPago" required>
            <option value="">Selecione método</option>
            <option value="Efectivo">Efectivo</option>
            <option value="Terminal">Terminal</option>
            <option value="Transferencia">Transferencia</option>
          </select>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-4">
          <label class="form-label">Vendedor</label>
          <select class="form-select" id="vendedor" required>
            <option value="">Seleccione vendedor</option>
            <!-- Lista de vendedores -->
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Persona que recibió el pago</label>
          <select class="form-select" id="receptorPago" required>
            <option value="">Seleccione receptor</option>
            <!-- Lista de receptores -->
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Guía para el tour</label>
          <select class="form-select" id="guia" multiple required>
            <!-- Lista de guías -->
          </select>
          <div id="guiaAvailability" class="availability-info"></div>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-12">
          <label class="form-label">Observaciones</label>
          <textarea class="form-control" id="observaciones" rows="3"></textarea>
        </div>
      </div>

      <div class="text-center">
        <button type="submit" class="btn btn-primary">Registrar Venta</button>
      </div>
    </form>
  </div>

  <div class="mt-4">
    <button id="exportExcel" class="btn btn-success mb-3">
      Exportar a Excel
    </button>
    
    <h3>Registro de Ventas</h3>
    <div class="table-responsive">
      <table class="table table-striped" id="ventasTable">
        <thead>
          <tr>
            <th>Fecha/Hora</th>
            <th>Cliente</th>
            <th>Tour</th>
            <th>Guía(s)</th>
            <th>Vehículo/Cuatrimoto</th>
            <th>Total</th>
            <th>Estado</th>
            <th>Vendedor</th>
            <th>Próxima Disponibilidad</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal fade" id="cancelacionModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cancelar Tour</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="cancelacionForm">
          <div class="mb-3">
            <label class="form-label">Motivo de Cancelación</label>
            <textarea class="form-control" id="motivoCancelacion" required></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-danger" id="confirmarCancelacion">Confirmar Cancelación</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const DURACIONES = {
  'Cabalgata': 90,
  'Cuatrimotos': 90,
  'ReservaVenados': 90,
  'TunelesVolcanicos': 120,
  'RutasLargas': 240
};

class Reserva {
  constructor(nombreCliente, telefonoCliente, fechaHora, duracion, recursos, isCanceled = false) {
    this.nombreCliente = nombreCliente;
    this.telefonoCliente = telefonoCliente;
    this.fechaHora = new Date(fechaHora);
    this.duracion = duracion;
    this.recursos = recursos;
    this.isCanceled = isCanceled;
    this.fechaFin = new Date(this.fechaHora.getTime() + duracion * 60000);
  }
}

class SistemaReservas {
  constructor() {
    this.reservas = [];
  }

  agregarReserva(reserva) {
    this.reservas.push(reserva);
  }

  estaDisponible(recurso, fechaHora, duracion) {
    const inicio = new Date(fechaHora);
    const fin = new Date(inicio.getTime() + duracion * 60000);
    return !this.reservas.some(reserva => {
      return reserva.recursos.includes(recurso) &&
             !(fin <= reserva.fechaHora || inicio >= reserva.fechaFin);
    });
  }

  proximaDisponibilidad(recurso, fechaHora) {
    const reservasRecurso = this.reservas
      .filter(r => r.recursos.includes(recurso) && !r.isCanceled)
      .sort((a, b) => a.fechaFin - b.fechaFin);

    if (reservasRecurso.length === 0) return new Date(fechaHora);
    const ultimaReserva = reservasRecurso[reservasRecurso.length - 1];
    return ultimaReserva.fechaFin;
  }
}

const sistemaReservas = new SistemaReservas();

function formatearFecha(fecha) {
  return new Date(fecha).toLocaleString();
}

document.getElementById('fechaHora').addEventListener('change', function() {
  actualizarDisponibilidad();
});

function actualizarDisponibilidad() {
  const fechaHora = document.getElementById('fechaHora').value;
  const tour = document.getElementById('tour').value;
  const duracion = DURACIONES[tour];

  if (!fechaHora || !tour) return;

  const guiaSelect = document.getElementById('guia');
  Array.from(guiaSelect.options).forEach(option => {
    const disponible = sistemaReservas.estaDisponible(option.value, fechaHora, duracion);
    option.classList.toggle('resource-unavailable', !disponible);
    if (!disponible) {
      const proxima = sistemaReservas.proximaDisponibilidad(option.value, fechaHora);
      option.title = `Próxima disponibilidad: ${formatearFecha(proxima)}`;
    }
  });
}

function validarDisponibilidad(fechaHora, recursos, duracion) {
  for (const recurso of recursos) {
    if (!sistemaReservas.estaDisponible(recurso, fechaHora, duracion)) {
      showAlert('El vehículo o guía que intentas registrar dentro del horario seleccionado, ya se encuentra ocupado');
      return false;
    }
  }
  return true;
}

function showAlert(message) {
  const alert = document.createElement('div');
  alert.className = 'alert alert-danger alert-dismissible fade show position-fixed top-50 start-50 translate-middle';
  alert.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  document.body.appendChild(alert);
  setTimeout(() => alert.remove(), 5000);
}

document.getElementById('ventasForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const fechaHora = document.getElementById('fechaHora').value;
  const tour = document.getElementById('tour').value;
  const duracion = DURACIONES[tour];
  const guias = Array.from(document.getElementById('guia').selectedOptions).map(opt => opt.value);
  const vehiculo = document.getElementById('vehiculo').value;
  
  const recursos = [...guias];
  if (tour === 'Cuatrimotos') {
    const cuatrimotosSeleccionadas = Array.from(document.querySelectorAll('#cuatrimotosDisponibles input:checked'))
      .map(input => input.value);
    recursos.push(...cuatrimotosSeleccionadas);
  } else if (vehiculo) {
    recursos.push(vehiculo);
  }

  if (!validarDisponibilidad(fechaHora, recursos, duracion)) return;

  const nuevaReserva = new Reserva(
    document.getElementById('nombreCliente').value,
    document.getElementById('telefonoCliente').value,
    fechaHora,
    duracion,
    recursos
  );

  sistemaReservas.agregarReserva(nuevaReserva);

  const tabla = document.getElementById('ventasTable').getElementsByTagName('tbody')[0];
  const row = tabla.insertRow();
  const index = tabla.rows.length - 1;
  row.innerHTML = `
    <td>${formatearFecha(fechaHora)}</td>
    <td>${document.getElementById('nombreCliente').value}</td>
    <td>${tour}</td>
    <td>${guias.join(', ')}</td>
    <td>${tour === 'Cuatrimotos' ? 
      Array.from(document.querySelectorAll('#cuatrimotosDisponibles input:checked'))
        .map(input => input.value)
        .join(', ') : (vehiculo || 'N/A')}</td>
    <td>$${document.getElementById('metodoPago').value === 'Terminal' ? 
      document.getElementById('costoTotalPagar').value : 
      document.getElementById('costoTour').value}</td>
    <td>${getTourStatus(fechaHora, duracion)}</td>
    <td>${document.getElementById('vendedor').value}</td>
    <td>${formatearFecha(nuevaReserva.fechaFin)}</td>
    <td>
      <button class="btn btn-sm btn-primary" onclick="editVenta(${index})">Editar</button>
      <button class="btn btn-sm btn-danger" onclick="showCancelacionModal(${index})">Cancelar</button>
    </td>
  `;

  this.reset();
  actualizarDisponibilidad();
});

function getTourStatus(fechaHora, duracion, isCanceled = false) {
  if (isCanceled) return 'Cancelado';
  
  const ahora = new Date();
  const inicio = new Date(fechaHora);
  const fin = new Date(inicio.getTime() + duracion * 60000);
  
  if (ahora < inicio) return 'Pendiente';
  if (ahora > fin) return 'Finalizado';
  return 'En Curso';
}

function editVenta(rowIndex) {
  const row = document.querySelector(`#ventasTable tbody tr:nth-child(${rowIndex + 1})`);
  if (!row) return;

  const cells = row.cells;
  
  const fechaHoraText = cells[0].textContent;
  const nombreCliente = cells[1].textContent;
  const tourText = cells[2].textContent;
  const guiasText = cells[3].textContent;
  const vehiculoText = cells[4].textContent;
  const costoText = cells[5].textContent.replace('$', '');
  
  try {
    const [datePart, timePart] = fechaHoraText.split(', ');
    const [day, month, year] = datePart.split('/');
    const [hours, minutes] = timePart.split(':');
    
    const fechaHora = new Date(year, month - 1, day, hours, minutes);
    
    const pad = num => num.toString().padStart(2, '0');
    const fechaHoraISO = `${year}-${pad(month)}-${pad(day)}T${pad(hours)}:${pad(minutes)}`;
    
    document.getElementById('fechaHora').value = fechaHoraISO;
  } catch (e) {
    console.error('Error parsing date:', e);
    const now = new Date();
    document.getElementById('fechaHora').value = now.toISOString().slice(0, 16);
  }

  document.getElementById('nombreCliente').value = nombreCliente;
  
  const tourSelect = document.getElementById('tour');
  Array.from(tourSelect.options).forEach(option => {
    if (option.text.includes(tourText)) {
      tourSelect.value = option.value;
      tourSelect.dispatchEvent(new Event('change'));
    }
  });

  const vehiculoSelect = document.getElementById('vehiculo');
  if (vehiculoText && vehiculoText !== 'N/A') {
    vehiculoSelect.value = vehiculoText;
  }

  const guiaSelect = document.getElementById('guia');
  const guiasArray = guiasText.split(', ');
  Array.from(guiaSelect.options).forEach(option => {
    option.selected = guiasArray.includes(option.value);
  });

  document.getElementById('costoTour').value = costoText;
  
  if (tourText.includes('Cuatrimotos')) {
    const cuatrimotosSeleccionadas = vehiculoText.split(', ');
    document.querySelectorAll('#cuatrimotosDisponibles input[type="checkbox"]').forEach(checkbox => {
      checkbox.checked = cuatrimotosSeleccionadas.includes(checkbox.value);
    });
    document.getElementById('cuatrimotosSection').style.display = 'block';
  } else {
    document.querySelectorAll('#cuatrimotosDisponibles input[type="checkbox"]').forEach(checkbox => {
      checkbox.checked = false;
    });
    document.getElementById('cuatrimotosSection').style.display = 'none';
  }

  if (document.getElementById('metodoPago').value === 'Terminal') {
    document.getElementById('costoTotalPagar').value = (parseFloat(costoText) * 1.04).toFixed(2);
    document.getElementById('costoTotalContainer').style.display = 'block';
  }
  
  const submitBtn = document.querySelector('button[type="submit"]');
  submitBtn.textContent = 'Actualizar Venta';
  submitBtn.dataset.editIndex = rowIndex;

  document.getElementById('ventasForm').scrollIntoView({ behavior: 'smooth' });
}

function showCancelacionModal(rowIndex) {
  const modal = new bootstrap.Modal(document.getElementById('cancelacionModal'));
  document.getElementById('confirmarCancelacion').onclick = function() {
    const motivo = document.getElementById('motivoCancelacion').value;
    if (!motivo) return;
    
    const row = document.querySelector(`#ventasTable tbody tr:nth-child(${rowIndex + 1})`);
    const statusCell = row.cells[6];
    statusCell.textContent = 'Cancelado';
    statusCell.classList.add('text-danger');
    
    document.getElementById('motivoCancelacion').value = '';
    modal.hide();
  };
  modal.show();
}

function inicializarSelectores() {
  const vendedores = ['Iván J', 'Monse', 'Erick V', 'Alexia', 'Fredy O', 'Ana', 'Manuel A', 'Luis A', 'Joaquín'];
  const receptoresPago = ['Iván J', 'Monse', 'Erick V', 'Alexia', 'Fredy O', 'Ana', 'Manuel A', 'Luis A', 'Mayra', 'Joaquín', 'Ángel', 'Alberto', 'Toño'];
  const guias = ['Alberto C', 'Iván J', 'Ángel', 'Toño', 'Luis A', 'Joaquín', 'Luis'];
  const cuatrimotos = ['Cuatri #1', 'Cuatri #2', 'Cuatri #3', 'Cuatri #4', 'Cuatri #5', 'Cuatri extra #6'];

  const vendedorSelect = document.getElementById('vendedor');
  const receptorSelect = document.getElementById('receptorPago');
  const guiaSelect = document.getElementById('guia');
  const cuatrimotosDiv = document.getElementById('cuatrimotosDisponibles');

  vendedores.forEach(v => {
    vendedorSelect.add(new Option(v, v));
  });

  receptoresPago.forEach(r => {
    receptorSelect.add(new Option(r, r));
  });

  guias.forEach(g => {
    guiaSelect.add(new Option(g, g));
  });

  cuatrimotos.forEach(c => {
    const div = document.createElement('div');
    div.innerHTML = `
      <input type="checkbox" class="form-check-input" id="${c}" value="${c}">
      <label class="form-check-label" for="${c}">${c}</label>
    `;
    cuatrimotosDiv.appendChild(div);
  });
}

document.getElementById('tour').addEventListener('change', function() {
  const tourSeleccionado = this.value;
  document.getElementById('vehiculoSection').style.display = 
    ['ReservaVenados', 'TunelesVolcanicos'].includes(tourSeleccionado) ? 'block' : 'none';
  document.getElementById('cuatrimotosSection').style.display = 
    tourSeleccionado === 'Cuatrimotos' ? 'block' : 'none';
  actualizarDisponibilidad();
});

document.getElementById('costoTour').addEventListener('input', function() {
  const metodoPago = document.getElementById('metodoPago').value;
  const costoBase = parseFloat(this.value) || 0;

  if (metodoPago === 'Terminal') {
    const costoTotal = costoBase * 1.04;
    document.getElementById('costoTotalPagar').value = costoTotal.toFixed(2);
    document.getElementById('costoTotalContainer').style.display = 'block';
  } else {
    document.getElementById('costoTotalContainer').style.display = 'none';
  }
  calcularPagoRestante();
});

document.getElementById('anticipo').addEventListener('input', calcularPagoRestante);
document.getElementById('metodoPago').addEventListener('change', function() {
  const costoTourElement = document.getElementById('costoTour');
  const costoTotalContainer = document.getElementById('costoTotalContainer');
  const costoTotalPagar = document.getElementById('costoTotalPagar');

  if (this.value === 'Terminal') {
    const costoTour = parseFloat(costoTourElement.value) || 0;
    const costoTotal = costoTour * 1.04;
    costoTotalPagar.value = costoTotal.toFixed(2);
    costoTotalContainer.style.display = 'block';
  } else {
    costoTotalContainer.style.display = 'none';
  }
  calcularPagoRestante();
});

function calcularPagoRestante() {
  const metodoPago = document.getElementById('metodoPago').value;
  const costoBase = parseFloat(document.getElementById('costoTour').value) || 0;
  const costoTotal = metodoPago === 'Terminal' ? costoBase * 1.04 : costoBase;
  const anticipo = parseFloat(document.getElementById('anticipo').value) || 0;
  const pagoRestante = costoTotal - anticipo;
  document.getElementById('pagoRestante').value = pagoRestante.toFixed(2);
}

document.getElementById('exportExcel').addEventListener('click', exportToExcel);

function exportToExcel() {
  const tabla = document.getElementById('ventasTable');
  const ws = XLSX.utils.table_to_sheet(tabla);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Registro de Ventas');
  XLSX.writeFile(wb, `Registro_Ventas_${new Date().toISOString().split('T')[0]}.xlsx`);
}

window.addEventListener('load', function() {
  inicializarSelectores();
  actualizarDisponibilidad();
});
</script>

</body></html>