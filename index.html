<html><head><base href="." />
<title>XTREME ADVENTURE - Sistema de Ventas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 20px;
    background-color: #f8f9fa;
    font-size: 14px;
    line-height: 1.4;
  }

  .header {
    background: linear-gradient(135deg, #1e4d92, #2c73d2);
    color: white;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 30px;
  }

  .form-container {
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0,0,0,0.1);
  }

  .table {
    table-layout: fixed;
    width: 100%;
  }

  .table th, .table td {
    vertical-align: middle;
    white-space: normal;
    word-wrap: break-word;
  }

  #ventasTable td:first-child, 
  #ventasTable th:first-child {
    width: 50px;
    text-align: center;
    display: none; /* Hidden by default */
  }

  /* Column widths */
  #ventasTable th:nth-child(2),  /* Cliente */
  #ventasTable td:nth-child(2) {
    width: 120px;
  }

  #ventasTable th:nth-child(3),  /* Tour */
  #ventasTable td:nth-child(3) {
    width: 140px;
  }

  #ventasTable th:nth-child(4),  /* Hora */
  #ventasTable td:nth-child(4) {
    width: 80px;
  }

  #ventasTable th:nth-child(5),  /* Guía(s) */
  #ventasTable td:nth-child(5) {
    width: 120px;
  }

  #ventasTable th:nth-child(6),  /* Vehículo */
  #ventasTable td:nth-child(6),
  #ventasTable th:nth-child(7),  /* Cuatrimoto */
  #ventasTable td:nth-child(7) {
    width: 100px;
  }

  #ventasTable th:nth-child(8),  /* Anticipo */
  #ventasTable td:nth-child(8),
  #ventasTable th:nth-child(9),  /* Pago Restante */
  #ventasTable td:nth-child(9),
  #ventasTable th:nth-child(10), /* Estado del Pago */
  #ventasTable td:nth-child(10),
  #ventasTable th:nth-child(11), /* Costo Total */
  #ventasTable td:nth-child(11) {
    width: 90px;
  }

  #ventasTable th:nth-child(12), /* Estado del Tour */
  #ventasTable td:nth-child(12) {
    width: 100px;
  }

  #ventasTable th:nth-child(13), /* Vendedor */
  #ventasTable td:nth-child(13) {
    width: 100px;
  }

  #ventasTable th:nth-child(14), /* Observaciones */
  #ventasTable td:nth-child(14) {
    width: 200px;
  }

  @media (max-width: 768px) {
    .table-responsive {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    #ventasTable td:first-child, 
    #ventasTable th:first-child {
      position: sticky;
      left: 0;
      background: white;
      z-index: 1;
      width: 40px;
    }
  }

  .table tbody tr:hover {
    background-color: #f5f5f5;
    cursor: pointer;
  }

  .resource-unavailable {
    color: #dc3545;
    background-color: #ffe6e6;
  }

  .resource-available {
    color: #198754;
  }

  .resource-disabled {
    opacity: 0.5;
    pointer-events: none;
    background-color: #f0f0f0;
  }

  .availability-info {
    font-size: 0.85em;
    color: #666;
    margin-left: 25px;
    margin-top: 2px;
    font-style: italic;
  }

  .unavailable {
    background-color: #ffe6e6;
  }

  .status-indicator {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-top: 10px;
    background: rgba(255, 255, 255, 0.2);
    padding: 5px 15px;
    border-radius: 20px;
    width: fit-content;
    margin: 10px auto 0;
  }

  .status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
  }

  .status-dot.online {
    background-color: #28a745;
    box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.2);
  }

  .status-dot.offline {
    background-color: #dc3545;
    box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.2);
  }

  .status-text {
    color: white;
    font-size: 0.9em;
  }

  @media (max-width: 768px) {
    .container {
      padding: 10px;
      margin: 0;
    }

    .header {
      padding: 15px;
      margin-bottom: 20px;
    }

    .form-container {
      padding: 15px;
    }

    .row {
      margin: 0;
    }

    .col-md-3, .col-md-4, .col-md-6 {
      padding: 5px;
    }

    .btn {
      width: 100%;
      margin: 5px 0;
    }

    .table-responsive {
      border: none;
    }

    .table {
      font-size: 0.85em;
    }

    .text-center .btn {
      display: block;
      margin: 10px auto;
    }

    .mb-3 {
      margin-bottom: 1rem !important;
    }

    input, select, textarea {
      font-size: 16px !important;
      padding: 10px !important;
    }

    .status-indicator {
      width: 90%;
      margin: 10px auto;
      padding: 8px;
    }

    .table-responsive {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .form-container .row > [class*='col-'] {
      width: 100%;
      margin-bottom: 15px;
    }

    .modal-dialog {
      margin: 10px;
      width: auto;
    }

    .modal-content {
      padding: 10px;
    }

    .form-check {
      padding: 10px 0;
    }

    .form-check-input {
      width: 20px;
      height: 20px;
      margin-right: 10px;
    }

    h1 {
      font-size: 1.8em;
    }

    h4 {
      font-size: 1.2em;
    }
  }

  #vehiculosDisponibles .form-check {
    margin-bottom: 10px;
    padding: 8px;
    border-radius: 4px;
    transition: background-color 0.2s;
  }

  #vehiculosDisponibles .form-check:hover {
    background-color: #f8f9fa;
  }

  #vehiculosDisponibles .form-check.resource-unavailable {
    color: #dc3545;
    background-color: #ffe6e6;
  }

  #vehiculosDisponibles .form-check.resource-available {
    color: #198754;
  }

  #guiasDisponibles .form-check {
    margin-bottom: 15px;
    padding: 8px;
    border-radius: 4px;
    transition: background-color 0.2s;
  }

  #guiasDisponibles .form-check.resource-unavailable {
    background-color: #ffe6e6;
    padding-bottom: 12px;
  }

  .venta-checkbox, #selectAllVentas {
    width: 20px;
    height: 20px;
    cursor: pointer;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    border: 2px solid #dee2e6;
    border-radius: 4px;
    outline: none;
    transition: all 0.2s ease-in-out;
    position: relative;
    background-color: white;
  }

  .venta-checkbox:checked, #selectAllVentas:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
  }

  .venta-checkbox:checked::before, #selectAllVentas:checked::before {
    content: '✓';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 12px;
  }

  @media (max-width: 768px) {
    .venta-checkbox, #selectAllVentas {
      width: 24px;
      height: 24px;
    }
  }
</style>
</head>
<body>

<div class="container">
  <div class="header text-center">
    <h1>XTREME ADVENTURE</h1>
    <h4>Sistema de Ventas 2.0</h4>
    <div class="status-indicator">
      <span class="status-dot"></span>
      <span class="status-text">Verificando conexión...</span>
    </div>
  </div>

  <div class="form-container">
    <form id="ventasForm">
      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">Nombre del Cliente</label>
          <input type="text" class="form-control" id="nombreCliente" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Teléfono del Cliente</label>
          <input type="tel" class="form-control" id="telefonoCliente" pattern="[0-9]*" onkeypress="return /[0-9]/i.test(event.key)" required>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-4">
          <label class="form-label">Tour</label>
          <select class="form-select" id="tour" required>
            <option value="">Seleccione un tour</option>
            <option value="Cabalgata">Cabalgata (1.5 hrs)</option>
            <option value="Cuatrimotos">Cuatrimotos (1.5 hrs)</option>
            <option value="ReservaVenados">Reserva de Venados (1.5 hrs)</option>
            <option value="TunelesVolcanicos">Túneles Volcánicos (2 hrs)</option>
            <option value="MixtoVenados">Mixto a Venados (1:40 hrs)</option>
            <option value="RutasLargas">Rutas Largas (3 hrs)</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Número de Personas</label>
          <input type="number" class="form-control" id="numPersonas" min="1" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">Fecha y Hora del Tour</label>
          <input type="datetime-local" class="form-control" id="fechaHora" required>
        </div>
      </div>

      <div id="cuatrimotosSection" style="display:none;">
        <div class="row mb-3">
          <div class="col-12">
            <label class="form-label">Cuatrimotos Disponibles</label>
            <div class="form-check">
              <div id="cuatrimotosDisponibles">
                <!-- Se llenará dinámicamente -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="vehiculoSection" style="display:none;">
        <div class="row mb-3">
          <div class="col-12">
            <label class="form-label">Vehículos Disponibles</label>
            <div id="vehiculosDisponibles">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="Aveo" id="vehiculo-aveo">
                <label class="form-check-label" for="vehiculo-aveo">Aveo</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="Pointer" id="vehiculo-pointer">
                <label class="form-check-label" for="vehiculo-pointer">Pointer</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="Sentra" id="vehiculo-sentra">
                <label class="form-check-label" for="vehiculo-sentra">Sentra</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="Taxi" id="vehiculo-taxi">
                <label class="form-check-label" for="vehiculo-taxi">Taxi</label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-3">
          <label class="form-label">Costo del Tour</label>
          <input type="number" class="form-control" id="costoTour" required>
        </div>
        <div class="col-md-3" id="costoTotalContainer" style="display:none;">
          <label class="form-label">Costo Total a pagar</label>
          <input type="number" class="form-control" id="costoTotalPagar" readonly>
        </div>
        <div class="col-md-3">
          <label class="form-label">Anticipo</label>
          <input type="number" class="form-control" id="anticipo" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">Pago Restante</label>
          <input type="number" class="form-control" id="pagoRestante" readonly>
        </div>
        <div class="col-md-3">
          <label class="form-label">Método de Pago</label>
          <select class="form-select" id="metodoPago" required>
            <option value="">Selecione método</option>
            <option value="Efectivo">Efectivo</option>
            <option value="Terminal">Terminal</option>
            <option value="Transferencia">Transferencia</option>
          </select>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-4">
          <label class="form-label">Vendedor</label>
          <select class="form-select" id="vendedor" required>
            <option value="">Seleccione vendedor</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Persona que recibió el pago</label>
          <select class="form-select" id="receptorPago" required>
            <option value="">Seleccione receptor</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Guías Disponibles</label>
          <div id="guiasDisponibles">
            <!-- Will be populated dynamically -->
          </div>
          <div id="guiaAvailability" class="availability-info"></div>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-12">
          <label class="form-label">Observaciones</label>
          <textarea class="form-control" id="observaciones" rows="3"></textarea>
        </div>
      </div>

      <div class="text-center">
        <button type="submit" class="btn btn-primary me-2">Registrar Venta</button>
        <button type="button" class="btn btn-secondary" id="limpiarFormulario">Limpiar Formulario</button>
      </div>
    </form>
  </div>

  <div class="mt-4">
    <button id="exportarPDF" class="btn btn-danger mb-3 ms-2">
      <i class="fas fa-file-pdf"></i> Exportar a PDF
    </button>
    <button id="exportarExcel" class="btn btn-success mb-3 ms-2">
      <i class="fas fa-download"></i> Descargar Registro en Excel
    </button>
    <button id="eliminarVentas" class="btn btn-danger mb-3 ms-2" style="display:none;">
      Eliminar Seleccionados
    </button>
    <button id="toggleEliminar" class="btn btn-warning mb-3 ms-2">
      Eliminar registros
    </button>

    <h3>Registro de Ventas</h3>
    <div class="table-responsive">
      <table class="table table-striped" id="ventasTable">
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAllVentas" class="form-check-input"> Seleccionar</th>
            <th>Cliente</th>
            <th>Tour</th>
            <th>Hora</th>
            <th>Guía(s)</th>
            <th>Vehículo</th>
            <th>Cuatrimoto</th>
            <th>Anticipo</th>
            <th style="color: inherit">Pago Restante</th>
            <th>Estado del Pago</th>
            <th>Costo Total</th>
            <th>Estado del Tour</th>
            <th>Vendedor</th>
            <th>Observaciones/Motivo de cancelación</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal fade" id="cancelacionModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cancelar Tour</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="cancelacionForm">
          <div class="mb-3">
            <label class="form-label">Motivo de Cancelación</label>
            <textarea class="form-control" id="motivoCancelacion" required></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-danger" id="confirmarCancelacion">Confirmar Cancelación</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
let deleteMode = false;
let selectedIndices = new Set();

const DURACIONES = {
  'Cabalgata': 90,
  'Cuatrimotos': 90,
  'ReservaVenados': 90,
  'TunelesVolcanicos': 120,
  'MixtoVenados': 100,
  'RutasLargas': 180
};

class Reserva {
  constructor(nombreCliente, telefonoCliente, fechaHora, duracion, recursos, observaciones, isCanceled = false) {
    this.nombreCliente = nombreCliente;
    this.telefonoCliente = telefonoCliente; 
    this.fechaHora = fechaHora;
    this.duracion = duracion;
    this.recursos = recursos;
    this.observaciones = observaciones;
    this.isCanceled = isCanceled;
    
    this.tour = null;
    this.numPersonas = null;
    this.costoTotal = null;
    this.anticipo = null;
    this.metodoPago = null;
    this.vendedor = null;
    this.receptorPago = null;
  }

  toJSON() {
    return {
      nombreCliente: this.nombreCliente,
      telefonoCliente: this.telefonoCliente,
      fechaHora: this.fechaHora,
      duracion: this.duracion,
      recursos: this.recursos,
      observaciones: this.observaciones,
      isCanceled: this.isCanceled,
      tour: this.tour,
      numPersonas: this.numPersonas,
      costoTotal: this.costoTotal,
      anticipo: this.anticipo,
      metodoPago: this.metodoPago,
      vendedor: this.vendedor,
      receptorPago: this.receptorPago
    };
  }
}

class ConnectionManager {
  constructor() {
    this.isOnline = navigator.onLine;
    this.setupListeners();
    this.updateStatus();
  }

  setupListeners() {
    window.addEventListener('online', () => {
      this.isOnline = true;
      this.updateStatus();
    });

    window.addEventListener('offline', () => {
      this.isOnline = false;
      this.updateStatus();
    });
  }

  updateStatus() {
    const statusDot = document.querySelector('.status-dot');
    const statusText = document.querySelector('.status-text');

    if (statusDot && statusText) {
      if (this.isOnline) {
        statusDot.classList.add('online');
        statusDot.classList.remove('offline');
        statusText.textContent = 'En Línea';
      } else {
        statusDot.classList.add('offline');
        statusDot.classList.remove('online');
        statusText.textContent = 'Sin Conexión';
      }
    }
  }
}

class RealtimeManager {
  constructor() {
    this.syncInterval = 1000; // Check every second
    this.lastSync = Date.now();
    this.setupSync();
    this.setupStorageListener();
    this.setupWebSocket(); // Add WebSocket support for real-time updates
  }

  setupWebSocket() {
    if (!window.WebSocket) {
      console.log('WebSocket not supported, using localStorage sync');
      return;
    }

    try {
      this.ws = new WebSocket('wss://your-websocket-server.com');
      
      this.ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          if (data.type === 'reservas_update') {
            this.handleRemoteUpdate(data.reservas);
          }
        } catch (error) {
          console.error('Error processing WebSocket message:', error);
        }
      };

      this.ws.onclose = () => {
        console.log('WebSocket connection closed, falling back to localStorage sync');
        setTimeout(() => this.setupWebSocket(), 5000);
      };
    } catch (error) {
      console.error('WebSocket connection failed:', error);
    }
  }

  setupSync() {
    setInterval(() => this.syncData(), this.syncInterval);
  }

  setupStorageListener() {
    window.addEventListener('storage', (e) => {
      if (e.key === 'reservas') {
        this.handleStorageChange(e);
      }
    });

    window.addEventListener('localStorageUpdated', () => {
      this.syncData();
    });
  }

  handleRemoteUpdate(reservas) {
    try {
      sistemaReservas.reservas = reservas.map(r => {
        const reserva = new Reserva(
          r.nombreCliente,
          r.telefonoCliente,
          r.fechaHora,
          r.duracion,
          r.recursos,
          r.observaciones,
          r.isCanceled
        );
        
        Object.assign(reserva, {
          tour: r.tour,
          numPersonas: r.numPersonas,
          costoTotal: r.costoTotal,
          anticipo: r.anticipo,
          metodoPago: r.metodoPago,
          vendedor: r.vendedor,
          receptorPago: r.receptorPago
        });
        
        return reserva;
      });
      
      renderizarReservasGuardadas();
    } catch (error) {
      console.error('Error handling remote update:', error);
    }
  }

  syncData() {
    const currentTime = Date.now();
    if (currentTime - this.lastSync >= this.syncInterval) {
      try {
        const storedData = localStorage.getItem('reservas');
        if (storedData) {
          const parsedData = JSON.parse(storedData);
          this.handleRemoteUpdate(parsedData);
          
          if (this.ws && this.ws.readyState === WebSocket.OPEN) {
            this.ws.send(JSON.stringify({
              type: 'reservas_update',
              reservas: parsedData
            }));
          }
        }
      } catch (error) {
        console.error('Error during sync:', error);
      }
      this.lastSync = currentTime;
    }
  }

  handleStorageChange(e) {
    if (e.newValue !== null) {
      try {
        const parsedData = JSON.parse(e.newValue);
        this.handleRemoteUpdate(parsedData);
      } catch (error) {
        console.error('Error handling storage change:', error);
      }
    }
  }
}

class SistemaReservas {
  constructor() {
    this.reservas = this.cargarReservas();
  }

  cargarReservas() {
    const reservasGuardadas = localStorage.getItem('reservas');
    if (!reservasGuardadas) return [];

    return JSON.parse(reservasGuardadas).map(r => {
      const reserva = new Reserva(
        r.nombreCliente,
        r.telefonoCliente,
        r.fechaHora,
        r.duracion,
        r.recursos,
        r.observaciones,
        r.isCanceled
      );
      
      reserva.tour = r.tour;
      reserva.numPersonas = r.numPersonas;
      reserva.costoTotal = r.costoTotal;
      reserva.anticipo = r.anticipo;
      reserva.metodoPago = r.metodoPago;
      reserva.vendedor = r.vendedor;
      reserva.receptorPago = r.receptorPago;
      
      return reserva;
    });
  }

  guardarReservas() {
    try {
      const data = JSON.stringify(this.reservas);
      localStorage.setItem('reservas', data);
      
      window.dispatchEvent(new Event('localStorageUpdated'));
      
      if (window.realtimeManager && 
          window.realtimeManager.ws && 
          window.realtimeManager.ws.readyState === WebSocket.OPEN) {
        window.realtimeManager.ws.send(JSON.stringify({
          type: 'reservas_update',
          reservas: this.reservas
        }));
      }
    } catch (error) {
      console.error('Error saving reservations:', error);
      alert('Error al guardar las reservas. Por favor intente nuevamente.');
    }
  }

  agregarReserva(reserva) {
    this.reservas.push(reserva);
    this.guardarReservas();
  }

  cancelarReserva(index) {
    if (this.reservas[index]) {
      this.reservas[index].isCanceled = true;
      this.guardarReservas();
    }
  }

  estaDisponible(recurso, fechaHora, duracion) {
    const inicio = new Date(fechaHora);
    const fin = new Date(inicio.getTime() + duracion * 60000);

    if (recurso.match(/^(Alberto C|Ana R|Ángel|Erick V|Iván J|Joaquín L|Luis A|Toño P|Otro)$/)) {
        const tourSelect = document.getElementById('tour');
        const isAtvTour = ['Cuatrimotos', 'RutasLargas', 'MixtoVenados'].includes(tourSelect.value);
        
        if (isAtvTour) {
            let guideCount = 0;
            this.reservas.forEach(reserva => {
                if (reserva.isCanceled) return false;
                
                const reservaInicio = new Date(reserva.fechaHora);
                const reservaFin = new Date(reservaInicio.getTime() + reserva.duracion * 60000);
                const hayConflicto = (inicio < reservaFin && fin > reservaInicio);
                
                if (hayConflicto && 
                    ['Cuatrimotos', 'RutasLargas', 'MixtoVenados'].includes(reserva.tour) && 
                    reserva.recursos.includes(recurso)) {
                    guideCount++;
                }
            });
            
            return guideCount < 3;
        }
    }

    return !this.reservas.some(reserva => {
        if (reserva.isCanceled) return false;

        const reservaInicio = new Date(reserva.fechaHora);
        const reservaFin = new Date(reservaInicio.getTime() + reserva.duracion * 60000);

        const hayConflicto = (inicio < reservaFin && fin > reservaInicio);
        return hayConflicto && reserva.recursos.includes(recurso);
    });
  }

  getNextAvailability(recurso, fechaHora) {
    const reservasRecurso = this.reservas
      .filter(r => !r.isCanceled && r.recursos.includes(recurso))
      .sort((a, b) => new Date(a.fechaHora) - new Date(b.fechaHora));

    const fechaInicio = new Date(fechaHora);
    
    for (let reserva of reservasRecurso) {
      const reservaFin = new Date(reserva.fechaHora);
      reservaFin.setMinutes(reservaFin.getMinutes() + reserva.duracion);
      
      if (reservaFin > fechaInicio) {
        return reservaFin;
      }
    }
    
    return fechaInicio;
  }
}

const sistemaReservas = new SistemaReservas();
const realtimeManager = new RealtimeManager();

function formatearFecha(fecha) {
  if (!fecha) return 'N/A';
  return new Date(fecha).toLocaleString('es-ES', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}

function actualizarDisponibilidad() {
  const fechaHoraInput = document.getElementById('fechaHora');
  const tourSelect = document.getElementById('tour');
  
  if (!fechaHoraInput?.value || !tourSelect?.value) return;

  const fechaHora = fechaHoraInput.value;
  const tour = tourSelect.value;
  const duracion = DURACIONES[tour];
  const isAtvTour = ['Cuatrimotos', 'RutasLargas', 'MixtoVenados'].includes(tour);

  const guiasCheckboxes = document.querySelectorAll('#guiasDisponibles input[type="checkbox"]');
  guiasCheckboxes.forEach(checkbox => {
    const disponible = sistemaReservas.estaDisponible(checkbox.value, fechaHora, duracion);
    checkbox.disabled = !disponible;
    const label = checkbox.parentElement;
    if (label) {
      const existingInfo = label.querySelector('.availability-info');
      if (existingInfo) {
        existingInfo.remove();
      }

      label.classList.toggle('resource-unavailable', !disponible);
      label.classList.toggle('resource-available', disponible);
      
      if (!disponible) {
        const nextAvailable = sistemaReservas.getNextAvailability(checkbox.value, fechaHora);
        const availabilityInfo = document.createElement('div');
        availabilityInfo.className = 'availability-info';
        availabilityInfo.textContent = `Próxima disponibilidad: ${formatearFecha(nextAvailable)}`;
        label.appendChild(availabilityInfo);
      } else if (isAtvTour) {
        let count = 0;
        sistemaReservas.reservas.forEach(reserva => {
          const reservaInicio = new Date(reserva.fechaHora);
          const reservaFin = new Date(reservaInicio.getTime() + reserva.duracion * 60000);
          const inicio = new Date(fechaHora);
          const fin = new Date(inicio.getTime() + duracion * 60000);
          
          if (!reserva.isCanceled && 
              (inicio < reservaFin && fin > reservaInicio) && 
              ['Cuatrimotos', 'RutasLargas', 'MixtoVenados'].includes(reserva.tour) && 
              reserva.recursos.includes(checkbox.value)) {
            count++;
          }
        });
        
        if (count > 0) {
          const availabilityInfo = document.createElement('div');
          availabilityInfo.className = 'availability-info';
          availabilityInfo.textContent = `Asignaciones de cuatrimoto: ${count}/3`;
          label.appendChild(availabilityInfo);
        }
      }
    }
  });

  const showVehicles = ['ReservaVenados', 'TunelesVolcanicos', 'MixtoVenados'].includes(tour);
  const showCuatrimotos = tour === 'Cuatrimotos' || tour === 'RutasLargas' || tour === 'MixtoVenados';

  document.getElementById('vehiculoSection').style.display = showVehicles ? 'block' : 'none';
  document.getElementById('cuatrimotosSection').style.display = showCuatrimotos ? 'block' : 'none';

  if (showVehicles) {
    const vehiculosCheckboxes = document.querySelectorAll('#vehiculosDisponibles input[type="checkbox"]');
    vehiculosCheckboxes.forEach(checkbox => {
      const disponible = sistemaReservas.estaDisponible(checkbox.value, fechaHora, duracion);
      checkbox.disabled = !disponible;
      const label = checkbox.parentElement;
      if (label) {
        label.classList.toggle('resource-unavailable', !disponible);
        label.classList.toggle('resource-available', disponible);
        
        if (!disponible) {
          const nextAvailable = sistemaReservas.getNextAvailability(checkbox.value, fechaHora);
          const availabilityInfo = document.createElement('div');
          availabilityInfo.className = 'availability-info';
          availabilityInfo.textContent = `Próxima disponibilidad: ${formatearFecha(nextAvailable)}`;
          label.appendChild(availabilityInfo);
        }
      }
    });
  }

  if (showCuatrimotos) {
    const cuatrimotosCheckboxes = document.querySelectorAll('#cuatrimotosDisponibles input[type="checkbox"]');
    cuatrimotosCheckboxes.forEach(checkbox => {
      const disponible = sistemaReservas.estaDisponible(checkbox.value, fechaHora, duracion);
      checkbox.disabled = !disponible;
      const label = checkbox.parentElement;
      if (label) {
        label.classList.toggle('resource-unavailable', !disponible);
        label.classList.toggle('resource-available', disponible);
        
        if (!disponible) {
          const nextAvailable = sistemaReservas.getNextAvailability(checkbox.value, fechaHora);
          const availabilityInfo = document.createElement('div');
          availabilityInfo.className = 'availability-info';
          availabilityInfo.textContent = `Próxima disponibilidad: ${formatearFecha(nextAvailable)}`;
          label.appendChild(availabilityInfo);
        }
      }
    });
  }
}

function editVenta(index) {
  const venta = sistemaReservas.reservas[index];
  
  document.getElementById('nombreCliente').value = venta.nombreCliente;
  document.getElementById('telefonoCliente').value = venta.telefonoCliente;
  document.getElementById('fechaHora').value = new Date(venta.fechaHora).toISOString().slice(0,16);
  document.getElementById('tour').value = venta.tour;
  document.getElementById('numPersonas').value = venta.numPersonas;
  document.getElementById('costoTour').value = venta.costoTotal;
  document.getElementById('anticipo').value = venta.anticipo;
  document.getElementById('metodoPago').value = venta.metodoPago;
  document.getElementById('vendedor').value = venta.vendedor;
  document.getElementById('receptorPago').value = venta.receptorPago;
  document.getElementById('observaciones').value = venta.observaciones;

  const showVehicles = ['ReservaVenados', 'TunelesVolcanicos', 'MixtoVenados'].includes(venta.tour);
  const showCuatrimotos = venta.tour === 'Cuatrimotos' || venta.tour === 'RutasLargas' || venta.tour === 'MixtoVenados';
  
  document.getElementById('vehiculoSection').style.display = showVehicles ? 'block' : 'none';
  document.getElementById('cuatrimotosSection').style.display = showCuatrimotos ? 'block' : 'none';

  document.querySelectorAll('#vehiculosDisponibles input[type="checkbox"], #cuatrimotosSection input[type="checkbox"], #guiasDisponibles input[type="checkbox"]')
    .forEach(checkbox => checkbox.checked = false);

  venta.recursos.forEach(recurso => {
    const checkbox = document.querySelector(`input[value="${recurso}"]`);
    if (checkbox) checkbox.checked = true;
  });

  if (venta.metodoPago === 'Terminal') {
    document.getElementById('costoTotalContainer').style.display = 'block';
    document.getElementById('costoTotalPagar').value = venta.costoTotal;
  } else {
    document.getElementById('costoTotalContainer').style.display = 'none';
  }

  const submitBtn = document.querySelector('button[type="submit"]');
  submitBtn.textContent = 'Actualizar Venta';
  submitBtn.dataset.editIndex = index;

  document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });
}

function showCancelacionModal(index) {
  const cancelacionModal = new bootstrap.Modal(document.getElementById('cancelacionModal'));
  const confirmarBtn = document.getElementById('confirmarCancelacion');
  
  confirmarBtn.onclick = function() {
    const motivo = document.getElementById('motivoCancelacion').value;
    if (!motivo) {
      alert('Por favor ingrese un motivo de cancelación');
      return;
    }
    
    sistemaReservas.cancelarReserva(index);
    sistemaReservas.reservas[index].observaciones = 
      (sistemaReservas.reservas[index].observaciones || '') + 
      '\nCANCELADO - Motivo: ' + motivo;
    
    sistemaReservas.guardarReservas();
    renderizarReservasGuardadas();
    
    cancelacionModal.hide();
    document.getElementById('motivoCancelacion').value = '';
  };
  
  cancelacionModal.show();
}

document.addEventListener('DOMContentLoaded', function() {
  const connectionManager = new ConnectionManager();
  const realtimeManager = new RealtimeManager();
  const costoTourInput = document.getElementById('costoTour');
  const anticipoInput = document.getElementById('anticipo');
  const metodoPagoSelect = document.getElementById('metodoPago');
  const costoTotalContainer = document.getElementById('costoTotalContainer');
  const costoTotalPagarInput = document.getElementById('costoTotalPagar');
  const pagoRestanteInput = document.getElementById('pagoRestante');
  const ventasForm = document.getElementById('ventasForm');
  const exportarPDFBtn = document.getElementById('exportarPDF');
  const exportarExcelBtn = document.getElementById('exportarExcel');
  const eliminarVentasBtn = document.getElementById('eliminarVentas');
  const toggleEliminarBtn = document.getElementById('toggleEliminar');
  
  const fechaHoraInput = document.getElementById('fechaHora');
  const tourSelect = document.getElementById('tour');

  if (fechaHoraInput) {
    fechaHoraInput.addEventListener('change', actualizarDisponibilidad);
  }
  
  if (tourSelect) {
    tourSelect.addEventListener('change', actualizarDisponibilidad);
  }

  if(costoTourInput) {
    costoTourInput.addEventListener('input', updateRemainingPayment);
  }
  
  if(anticipoInput) {
    anticipoInput.addEventListener('input', updateRemainingPayment);
  }
  
  if(metodoPagoSelect) {
    metodoPagoSelect.addEventListener('change', function() {
      const costoTour = parseFloat(costoTourInput?.value) || 0;
      
      if (this.value === 'Terminal') {
        if(costoTotalPagarInput) costoTotalPagarInput.value = (costoTour * 1.04).toFixed(2);
        if(costoTotalContainer) costoTotalContainer.style.display = 'block';
      } else {
        if(costoTotalContainer) costoTotalContainer.style.display = 'none';
        if(costoTotalPagarInput) costoTotalPagarInput.value = '';
      }
      
      updateRemainingPayment();
    });
  }

  function updateRemainingPayment() {
    const costoTour = parseFloat(costoTourInput?.value) || 0;
    const anticipo = parseFloat(anticipoInput?.value) || 0;
    const metodoPago = metodoPagoSelect?.value;
    
    let costoTotal = costoTour;
    if (metodoPago === 'Terminal') {
      costoTotal = costoTour * 1.04;
    }
    
    const pagoRestante = costoTotal - anticipo;
    if(pagoRestanteInput) {
      pagoRestanteInput.value = pagoRestante.toFixed(2);
    }
  }

  ventasForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const connectionManager = new ConnectionManager();
    if (!connectionManager.isOnline) {
      alert('No hay conexión a internet. Por favor, verifique su conexión e intente nuevamente.');
      return;
    }

    const nombreCliente = document.getElementById('nombreCliente').value;
    const telefonoCliente = document.getElementById('telefonoCliente').value;
    const fechaHora = document.getElementById('fechaHora').value;
    const tour = document.getElementById('tour').value;
    const numPersonas = document.getElementById('numPersonas').value;
    const duracion = DURACIONES[tour];
    const costoTour = parseFloat(document.getElementById('costoTour').value);
    const anticipo = parseFloat(document.getElementById('anticipo').value);
    const metodoPago = document.getElementById('metodoPago').value;
    const vendedor = document.getElementById('vendedor').value;
    const receptorPago = document.getElementById('receptorPago').value;
    const observaciones = document.getElementById('observaciones').value;
    
    const guias = Array.from(document.querySelectorAll('#guiasDisponibles input:checked'))
      .map(input => input.value);
    
    const vehiculos = Array.from(document.querySelectorAll('#vehiculosDisponibles input:checked'))
      .map(input => input.value);
        
    const cuatrimotos = Array.from(document.querySelectorAll('#cuatrimotosDisponibles input:checked'))
      .map(input => input.value);
    
    const recursos = [...guias, ...vehiculos, ...cuatrimotos];
    
    let costoTotal = costoTour;
    if (metodoPago === 'Terminal') {
      costoTotal = costoTour * 1.04;
    }
    
    const nuevaReserva = new Reserva(
      nombreCliente,
      telefonoCliente,
      fechaHora,
      duracion,
      recursos,
      observaciones
    );
    
    nuevaReserva.tour = tour;
    nuevaReserva.numPersonas = parseInt(numPersonas);
    nuevaReserva.costoTotal = costoTotal;
    nuevaReserva.anticipo = anticipo;
    nuevaReserva.metodoPago = metodoPago;
    nuevaReserva.vendedor = vendedor;
    nuevaReserva.receptorPago = receptorPago;
    
    const submitBtn = document.querySelector('button[type="submit"]');
    if (submitBtn.dataset.editIndex) {
      const index = parseInt(submitBtn.dataset.editIndex);
      sistemaReservas.reservas[index] = nuevaReserva;
      delete submitBtn.dataset.editIndex;
      submitBtn.textContent = 'Registrar Venta';
    } else {
      sistemaReservas.agregarReserva(nuevaReserva);
    }
    
    try {
      sistemaReservas.guardarReservas();
      renderizarReservasGuardadas();
      
      document.getElementById('limpiarFormulario').click();
      
      alert('Venta registrada exitosamente');
    } catch (error) {
      console.error('Error al guardar la venta:', error);
      alert('Error al guardar la venta. Por favor intente nuevamente.');
    }
  });

  toggleEliminarBtn.addEventListener('click', toggleDeleteMode);
  eliminarVentasBtn.addEventListener('click', deleteSelectedVentas);
  exportarPDFBtn.addEventListener('click', exportarAPDF);
  exportarExcelBtn.addEventListener('click', exportarAExcel);

  initializeSelectors();
  actualizarDisponibilidad();
  renderizarReservasGuardadas();
});

function renderizarReservasGuardadas() {
  const tabla = document.getElementById('ventasTable').getElementsByTagName('tbody')[0];
  tabla.innerHTML = '';
  
  const headerRow = document.querySelector('#ventasTable thead tr');
  headerRow.innerHTML = `
    <th style="display: ${deleteMode ? 'table-cell' : 'none'}">
      <input type="checkbox" id="selectAllVentas" class="form-check-input">
    </th>
    <th>Cliente</th>
    <th>Tour</th>
    <th>Hora</th>
    <th>Guía(s)</th>
    <th>Vehículo</th>
    <th>Cuatrimoto</th>
    <th>Anticipo</th>
    <th>Pago Restante</th>
    <th>Estado del Pago</th>
    <th>Costo Total</th>
    <th>Estado del Tour</th>
    <th>Vendedor</th>
    <th>Observaciones</th>
    <th>Acciones</th>
  `.trim();

  sistemaReservas.reservas.forEach((reserva, index) => {
    const row = tabla.insertRow();
    const firstCell = row.insertCell();
    firstCell.style.display = deleteMode ? 'table-cell' : 'none';
    firstCell.innerHTML = `
      <input type="checkbox" 
             class="venta-checkbox form-check-input" 
             data-index="${index}" 
             ${selectedIndices.has(index) ? 'checked' : ''}>
    `;

    const tourDisplayNames = {
      'Cabalgata': 'Cabalgata (1.5 hrs)',
      'Cuatrimotos': 'Cuatrimotos (1.5 hrs)',
      'ReservaVenados': 'Reserva de Venados (1.5 hrs)',
      'TunelesVolcanicos': 'Túneles Volcánicos (2 hrs)',
      'MixtoVenados': 'Mixto a Venados (1:40 hrs)',
      'RutasLargas': 'Rutas Largas (3 hrs)'
    };

    const pagoRestante = reserva.costoTotal - reserva.anticipo;
    const estadoPago = pagoRestante <= 0 ? 'Liquidado' : 'Pendiente';

    row.innerHTML += `
      <td>${reserva.nombreCliente}</td>
      <td>${tourDisplayNames[reserva.tour] || reserva.tour}</td>
      <td>${new Date(reserva.fechaHora).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
      <td>${reserva.recursos.filter(r => !r.includes('Cuatri') && !['Aveo', 'Pointer', 'Sentra', 'Taxi'].includes(r)).join(', ') || 'N/A'}</td>
      <td>${reserva.recursos.filter(r => ['Aveo', 'Pointer', 'Sentra', 'Taxi'].includes(r)).join(', ') || 'N/A'}</td>
      <td>${reserva.recursos.filter(r => r.includes('Cuatri')).join(', ') || 'N/A'}</td>
      <td>$${reserva.anticipo || '0'}</td>
      <td style="color: ${pagoRestante > 0 ? '#dc3545' : 'inherit'}">$${pagoRestante.toFixed(2)}</td>
      <td style="color: ${pagoRestante > 0 ? '#dc3545' : '#198754'}">${estadoPago}</td>
      <td>$${reserva.costoTotal || ''}</td>
      <td class="${reserva.isCanceled ? 'text-danger' : ''}">${getTourStatus(reserva.fechaHora, reserva.duracion, reserva.isCanceled)}</td>
      <td>${reserva.vendedor || ''}</td>
      <td>${reserva.observaciones || ''}</td>
      <td>
        <button class="btn btn-sm btn-primary" onclick="editVenta(${index})">Editar</button>
        <button class="btn btn-sm btn-danger" onclick="showCancelacionModal(${index})">Cancelar</button>
      </td>
    `;
  });

  // Reinitialize checkbox functionality
  const selectAllCheckbox = document.getElementById('selectAllVentas');
  if (selectAllCheckbox) {
    selectAllCheckbox.removeEventListener('change', handleSelectAll);
    selectAllCheckbox.addEventListener('change', handleSelectAll);
    updateSelectAllState();
  }

  // Add listeners to individual checkboxes
  document.querySelectorAll('.venta-checkbox').forEach(checkbox => {
    checkbox.removeEventListener('change', handleIndividualCheckbox);
    checkbox.addEventListener('change', handleIndividualCheckbox);
  });
}

function handleSelectAll(event) {
  event.stopPropagation();
  
  const checkboxes = document.querySelectorAll('.venta-checkbox');
  const isChecked = event.target.checked;
  
  checkboxes.forEach(checkbox => {
    checkbox.checked = isChecked;
    const index = parseInt(checkbox.dataset.index);
    
    if (isChecked) {
      selectedIndices.add(index);
    } else {
      selectedIndices.delete(index);
    }
  });
}

function handleIndividualCheckbox(event) {
  event.stopPropagation();
  
  const index = parseInt(event.target.dataset.index);
  if (event.target.checked) {
    selectedIndices.add(index);
  } else {
    selectedIndices.delete(index);
  }
  
  updateSelectAllState();
}

function updateSelectAllState() {
  const selectAllCheckbox = document.getElementById('selectAllVentas');
  const checkboxes = Array.from(document.querySelectorAll('.venta-checkbox'));
  
  if (checkboxes.length === 0) {
    selectAllCheckbox.checked = false;
    selectAllCheckbox.indeterminate = false;
    return;
  }
  
  const checkedCount = checkboxes.filter(cb => cb.checked).length;
  
  if (checkedCount === 0) {
    selectAllCheckbox.checked = false;
    selectAllCheckbox.indeterminate = false;
  } else if (checkedCount === checkboxes.length) {
    selectAllCheckbox.checked = true;
    selectAllCheckbox.indeterminate = false;
  } else {
    selectAllCheckbox.checked = false;
    selectAllCheckbox.indeterminate = true;
  }
}

function getTourStatus(fechaHora, duracion, isCanceled = false) {
  if (isCanceled) return 'Cancelado';
  
  const ahora = new Date();
  const inicio = new Date(fechaHora);
  const fin = new Date(inicio.getTime() + duracion * 60000);
  
  if (ahora < inicio) return 'Pendiente';
  if (ahora > fin) return 'Finalizado';
  return 'En Curso';
}

function toggleDeleteMode() {
  deleteMode = !deleteMode;
  
  // Get all checkbox cells
  const checkboxCells = document.querySelectorAll('#ventasTable td:first-child, #ventasTable th:first-child');
  
  // Show/hide checkbox column
  checkboxCells.forEach(cell => {
    cell.style.display = deleteMode ? 'table-cell' : 'none';
  });
  
  // Show/hide delete button
  const deleteBtn = document.getElementById('eliminarVentas');
  if(deleteBtn) {
    deleteBtn.style.display = deleteMode ? 'inline-block' : 'none';
  }
  
  // Update toggle button
  const toggleBtn = document.getElementById('toggleEliminar');
  if(toggleBtn) {
    toggleBtn.textContent = deleteMode ? 'Cancelar' : 'Eliminar registros';
    toggleBtn.classList.toggle('btn-danger');
    toggleBtn.classList.toggle('btn-warning');
  }

  // Reset selections when exiting delete mode
  if(!deleteMode) {
    selectedIndices.clear();
    const selectAllCheckbox = document.getElementById('selectAllVentas');
    if(selectAllCheckbox) {
      selectAllCheckbox.checked = false;
      selectAllCheckbox.indeterminate = false;
    }
    document.querySelectorAll('.venta-checkbox').forEach(cb => {
      cb.checked = false;
    });
  }
  
  // Force table layout recalculation
  const table = document.getElementById('ventasTable');
  if(table) {
    table.style.display = 'none';
    setTimeout(() => {
      table.style.display = 'table';
    }, 0);
  }
}

function deleteSelectedVentas() {
  if (selectedIndices.size === 0) {
    alert('Por favor seleccione al menos una venta para eliminar');
    return;
  }
  
  if (confirm(`¿Está seguro que desea eliminar ${selectedIndices.size} registro(s)?`)) {
    const indicesToDelete = Array.from(selectedIndices).sort((a, b) => b - a);
    
    indicesToDelete.forEach(index => {
      sistemaReservas.reservas.splice(index, 1);
    });
    
    selectedIndices.clear();
    sistemaReservas.guardarReservas();
    renderizarReservasGuardadas();
    toggleDeleteMode();
  }
}

function exportarAPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({
    orientation: 'landscape',
    unit: 'mm',
    format: 'a4'
  });
  
  const table = document.getElementById('ventasTable');
  const headerRow = Array.from(table.querySelectorAll('thead th'))
    .map(th => th.textContent)
    .filter(text => text !== 'Seleccionar' && text !== 'Acciones');
  
  const dataRows = Array.from(table.querySelectorAll('tbody tr')).map(row => {
    return Array.from(row.cells)
      .map(cell => cell.textContent)
      .filter((_, index) => index !== 0 && index !== row.cells.length - 1);
  });
  
  doc.text('Registro de Ventas - Xtreme Adventure', 14, 15);
  
  doc.autoTable({
    head: [headerRow],
    body: dataRows,
    startY: 25,
    theme: 'grid',
    styles: {
      fontSize: 7,
      cellPadding: 1,
      overflow: 'linebreak',
      halign: 'left'
    },
    columnStyles: {
      0: { cellWidth: 25 }, // Cliente
      1: { cellWidth: 25 }, // Tour
      2: { cellWidth: 20 }, // Hora
      3: { cellWidth: 25 }, // Guía(s)
      4: { cellWidth: 20 }, // Vehículo
      5: { cellWidth: 20 }, // Cuatrimoto
      6: { cellWidth: 20 }, // Anticipo
      7: { cellWidth: 20 }, // Pago Restante
      8: { cellWidth: 20 }, // Estado del Pago
      9: { cellWidth: 20 }, // Costo Total
      10: { cellWidth: 20 }, // Estado del Tour
      11: { cellWidth: 25 }, // Vendedor
      12: { cellWidth: 35 }  // Observaciones
    },
    margin: { left: 10, right: 10 },
    didDrawPage: function(data) {
      doc.text(
        'Página ' + doc.internal.getCurrentPageInfo().pageNumber,
        data.settings.margin.left,
        doc.internal.pageSize.height - 10
      );
    }
  });
  
  doc.save(`registro_ventas_${new Date().toISOString().slice(0,10)}.pdf`);
}

function exportarAExcel() {
  const table = document.getElementById('ventasTable');
  const rows = Array.from(table.querySelectorAll('tbody tr'));

  // Check if there are records to export
  if (rows.length === 0) {
    alert('No hay registros disponibles para descargar en Excel.');
    return;
  }

  // Define headers in the specified order
  const headers = [
    'Cliente', 'Tour', 'Hora', 'Guía(s)', 'Vehículo', 'Cuatrimoto',
    'Anticipo', 'Pago Restante', 'Estado del Pago', 'Costo Total',
    'Estado del Tour', 'Vendedor', 'Observaciones'
  ];
  
  // Extract data from table rows, excluding checkbox and actions columns
  const data = rows.map(row => {
    const cells = Array.from(row.cells);
    return [
      cells[1].textContent.trim(),  // Cliente
      cells[2].textContent.trim(),  // Tour
      cells[3].textContent.trim(),  // Hora
      cells[4].textContent.trim(),  // Guía(s)
      cells[5].textContent.trim(),  // Vehículo
      cells[6].textContent.trim(),  // Cuatrimoto
      cells[7].textContent.trim(),  // Anticipo
      cells[8].textContent.trim(),  // Pago Restante
      cells[9].textContent.trim(),  // Estado del Pago
      cells[10].textContent.trim(), // Costo Total
      cells[11].textContent.trim(), // Estado del Tour
      cells[12].textContent.trim(), // Vendedor
      cells[13].textContent.trim()  // Observaciones
    ];
  });

  try {
    // Create worksheet with headers and data
    const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);

    // Set column widths for better readability
    const colWidths = [
      {wch: 25}, // Cliente
      {wch: 25}, // Tour
      {wch: 10}, // Hora
      {wch: 25}, // Guía(s)
      {wch: 15}, // Vehículo
      {wch: 15}, // Cuatrimoto
      {wch: 12}, // Anticipo
      {wch: 15}, // Pago Restante
      {wch: 15}, // Estado del Pago
      {wch: 12}, // Costo Total
      {wch: 15}, // Estado del Tour
      {wch: 20}, // Vendedor
      {wch: 40}  // Observaciones
    ];
    ws['!cols'] = colWidths;

    // Apply styles to headers
    const headerRange = XLSX.utils.decode_range(ws['!ref']);
    for (let C = headerRange.s.c; C <= headerRange.e.c; ++C) {
      const address = XLSX.utils.encode_cell({r: 0, c: C});
      ws[address].s = {
        font: { bold: true },
        fill: { fgColor: { rgb: "CCCCCC" } }
      };
    }

    // Create workbook and append worksheet
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Registro de Ventas");

    // Generate filename with current date in DD-MM-YYYY format
    const today = new Date();
    const dd = String(today.getDate()).padStart(2, '0');
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const yyyy = today.getFullYear();
    const fileName = `Registro_de_Ventas_Xtreme_Adventure_${dd}-${mm}-${yyyy}.xlsx`;

    // Write file and trigger download
    XLSX.writeFile(wb, fileName);
  } catch (error) {
    console.error('Error al exportar a Excel:', error);
    alert('Ocurrió un error al generar el archivo Excel. Por favor intente nuevamente.');
  }
}

function initializeSelectors() {
  const vendedores = [
    'Alexia', 'Ana R', 'Erick V', 'Fredy O', 'Iván J',
    'Jackie T', 'Joaquin L', 'Jonathan', 'Luis A', 'Manuel A', 'Monse'
  ];
  
  const receptores = [
    'Alexia', 'Ana R', 'Erick V', 'Fredy O', 'Iván J',
    'Jackie T', 'Joaquin L', 'Jonathan', 'Luis A', 'Manuel A', 'Mayra B', 'Monse'
  ];
  
  // Ensure the guias array is correctly defined
  const guias = [
    'Alberto C', 'Ana R', 'Ángel', 'Erick V', 'Iván J', 'Joaquín L',
    'Luis A', 'Toño P', 'Otro'
  ].sort();

  const guiasContainer = document.getElementById('guiasDisponibles');
  guiasContainer.innerHTML = ''; // Clear existing content

  guias.forEach(guia => {
    const guiaDiv = document.createElement('div');
    guiaDiv.className = 'form-check';
    
    const input = document.createElement('input');
    input.type = 'checkbox';
    input.className = 'form-check-input';
    input.id = `guia-${guia.toLowerCase().replace(/\s+/g, '-')}`;
    input.value = guia;
    
    const label = document.createElement('label');
    label.className = 'form-check-label';
    label.htmlFor = input.id;
    label.textContent = guia;
    
    guiaDiv.appendChild(input);
    guiaDiv.appendChild(label);
    guiasContainer.appendChild(guiaDiv);
  });

  const vendedorSelect = document.getElementById('vendedor');
  vendedorSelect.innerHTML = '<option value="">Seleccione vendedor</option>';
  vendedores.forEach(vendedor => {
    const option = document.createElement('option');
    option.value = vendedor;
    option.textContent = vendedor;
    vendedorSelect.appendChild(option);
  });

  const receptorSelect = document.getElementById('receptorPago');
  receptorSelect.innerHTML = '<option value="">Seleccione receptor</option>';
  receptores.forEach(receptor => {
    const option = document.createElement('option');
    option.value = receptor;
    option.textContent = receptor;
    receptorSelect.appendChild(option);
  });
}

// Ensure DOM is loaded before initializing
document.addEventListener('DOMContentLoaded', function() {
  initializeSelectors();
  actualizarDisponibilidad();
  renderizarReservasGuardadas();

  document.getElementById('limpiarFormulario').addEventListener('click', function() {
    document.getElementById('nombreCliente').value = '';
    document.getElementById('telefonoCliente').value = '';
    document.getElementById('fechaHora').value = '';
    document.getElementById('tour').value = '';
    document.getElementById('numPersonas').value = '';
    document.getElementById('costoTour').value = '';
    document.getElementById('anticipo').value = '';
    document.getElementById('metodoPago').value = '';
    document.getElementById('vendedor').value = '';
    document.getElementById('receptorPago').value = '';
    document.getElementById('observaciones').value = '';
    document.getElementById('pagoRestante').value = '';

    document.getElementById('costoTotalContainer').style.display = 'none';
    document.getElementById('costoTotalPagar').value = '';

    document.querySelectorAll('#vehiculosDisponibles input[type="checkbox"], #cuatrimotosSection input[type="checkbox"], #guiasDisponibles input[type="checkbox"]').forEach(checkbox => {
      checkbox.checked = false;
    });

    document.getElementById('vehiculoSection').style.display = 'none';
    document.getElementById('cuatrimotosSection').style.display = 'none';

    const submitBtn = document.querySelector('button[type="submit"]');
    if (submitBtn.dataset.editIndex) {
      delete submitBtn.dataset.editIndex;
      submitBtn.textContent = 'Registrar Venta';
    }
  });
});
</script>

</body></html>